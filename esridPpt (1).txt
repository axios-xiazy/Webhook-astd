-- Wait for game to load
repeat wait() until game:IsLoaded()

-- Services
local Players = game:GetService("Players")
local ReplicatedStorage = game:GetService("ReplicatedStorage")
local HttpService = game:GetService("HttpService")

-- Wave tracking
local Wave = ReplicatedStorage:WaitForChild("Wave")

-- Modules
local InventoryMod = require(ReplicatedStorage.Mods.InventoryMod)

-- Configuration
local CONFIG = {
    WEBHOOK_URL = _G.WebhookLink,
    COLORS = {
        VICTORY = 0x00FF00,    -- à¹€à¸‚à¸µà¸¢à¸§à¸ªà¸³à¸«à¸£à¸±à¸šà¸Šà¸±à¸¢à¸Šà¸™à¸°
        DEFEAT = 0xFF0000,     -- à¹à¸”à¸‡à¸ªà¸³à¸«à¸£à¸±à¸šà¸à¹ˆà¸²à¸¢à¹à¸à¹‰
        DEFAULT = 0x7289DA,    -- à¸ªà¸µà¹€à¸£à¸´à¹ˆà¸¡à¸•à¹‰à¸™
        CHARACTER_DROP = 0xFFD700, -- à¸—à¸­à¸‡à¸ªà¸³à¸«à¸£à¸±à¸šà¸”à¸£à¸­à¸›à¸•à¸±à¸§à¸¥à¸°à¸„à¸£
        SPECIAL = 0xFF00FF,    -- à¸¡à¹ˆà¸§à¸‡à¸ªà¸³à¸«à¸£à¸±à¸šà¹€à¸«à¸•à¸¸à¸à¸²à¸£à¸“à¹Œà¸à¸´à¹€à¸¨à¸©
        UPGRADE = 0x00FFFF     -- à¸Ÿà¹‰à¸²à¸ªà¸³à¸«à¸£à¸±à¸šà¸à¸²à¸£à¸­à¸±à¸›à¹€à¸à¸£à¸”
    },
    ICONS = {
        TIME = "â±ï¸",
        DAMAGE = "ğŸ’¥",
        ELIMINATIONS = "âš”ï¸",
        WORLD = "ğŸŒ",
        CHAPTER = "ğŸ“–",
        XP = "âœ¨",
        REWARDS = "ğŸ",
        VICTORY = "ğŸ†",
        DEFEAT = "ğŸ˜¢",
        SUMMARY = "ğŸ“Š",
        WAVE = "ğŸŒŠ",
        CHARACTER = "ğŸ¦¸â€â™‚ï¸",
        DIFFICULTY = "ğŸ¯",
        PLAYERS = "ğŸ‘¥",
        GEMS = "ğŸ’",
        LEVEL = "ğŸ“ˆ",
        UPGRADE = "âš™ï¸"
    }
}

-- Utility Functions
local Utils = {}

function Utils.formatTime(seconds)
    local fraction = seconds - math.floor(seconds)
    local totalSeconds = math.floor(seconds)
    local hours = math.floor(totalSeconds / 3600)
    local minutes = math.floor((totalSeconds % 3600) / 60)
    local secs = (totalSeconds % 60) + fraction

    if hours > 0 then
        return string.format("%d à¸Šà¸±à¹ˆà¸§à¹‚à¸¡à¸‡ %02d à¸™à¸²à¸—à¸µ %05.2f à¸§à¸´à¸™à¸²à¸—à¸µ", hours, minutes, secs)
    elseif minutes > 0 then
        return string.format("%d à¸™à¸²à¸—à¸µ %05.2f à¸§à¸´à¸™à¸²à¸—à¸µ", minutes, secs)
    else
        return string.format("%05.2f à¸§à¸´à¸™à¸²à¸—à¸µ", secs)
    end
end

function Utils.formatNumber(number)
    local formatted = tostring(number)
    while true do
        formatted, k = string.gsub(formatted, "^(-?%d+)(%d%d%d)", '%1,%2')
        if k == 0 then break end
    end
    return formatted
end

function Utils.getItemAmount(itemName)
    for _, item in pairs(InventoryMod.Get()) do
        if item.Name == itemName then
            return item.Amount
        end
    end
    return 0
end

function Utils.getDifficultyName(difficulty)
    local difficultyMap = {
        ["Easy"] = "à¸‡à¹ˆà¸²à¸¢",
        ["Normal"] = "à¸›à¸à¸•à¸´",
        ["Hard"] = "à¸¢à¸²à¸",
        ["Extreme"] = "à¸ªà¸¸à¸”à¸‚à¸µà¸”",
        ["Infinite"] = "à¹„à¸¡à¹ˆà¸¡à¸µà¸—à¸µà¹ˆà¸ªà¸´à¹‰à¸™à¸ªà¸¸à¸”"
    }
    return difficultyMap[difficulty] or difficulty or "à¹„à¸¡à¹ˆà¸—à¸£à¸²à¸šà¸£à¸°à¸”à¸±à¸š"
end

function Utils.getPlayerCount()
    return #Players:GetPlayers()
end

function Utils.getPlayerLevel()
    local player = Players.LocalPlayer
    return player:FindFirstChild("leaderstats") and player.leaderstats:FindFirstChild("Level") and player.leaderstats.Level.Value or "à¹„à¸¡à¹ˆà¸—à¸£à¸²à¸šà¹€à¸¥à¹€à¸§à¸¥"
end

-- Webhook Functions
local Webhook = {}

function Webhook.createEmbed(gameData, gems)
    local info = gameData.Info
    local result = info.Result
    local isVictory = result.Win

    local totalTime = result.Description[1] and result.Description[1].V or 0
    local currentWave = Wave.Value
    local difficulty = info.Difficulty or "Unknown"
    local playerCount = Utils.getPlayerCount()
    local playerLevel = Utils.getPlayerLevel()

    local summaryLines = {
        string.format("%s **à¸­à¸±à¸à¸¡à¸“à¸µà¸—à¸µà¹ˆà¹„à¸”à¹‰à¸£à¸±à¸š:** %s", CONFIG.ICONS.GEMS, Utils.formatNumber(gems or 0)),
        string.format("%s **à¹‚à¸¥à¸:** %s", CONFIG.ICONS.WORLD, info.World.DisplayName),
        string.format("%s **à¸šà¸—à¸—à¸µà¹ˆ %d** â€” *%s*", CONFIG.ICONS.CHAPTER, info.Chapter.Chapter, info.Chapter.Name),
        string.format("%s **à¸£à¸°à¸”à¸±à¸šà¸„à¸§à¸²à¸¡à¸¢à¸²à¸:** %s", CONFIG.ICONS.DIFFICULTY, Utils.getDifficultyName(difficulty)),
        string.format("%s **à¸ˆà¸³à¸™à¸§à¸™à¸œà¸¹à¹‰à¹€à¸¥à¹ˆà¸™:** %s", CONFIG.ICONS.PLAYERS, Utils.formatNumber(playerCount)),
        string.format("%s **à¹€à¸¥à¹€à¸§à¸¥à¸œà¸¹à¹‰à¹€à¸¥à¹ˆà¸™:** %s", CONFIG.ICONS.LEVEL, Utils.formatNumber(playerLevel)),
        string.format("%s **à¹€à¸§à¸¥à¸²à¹€à¸¥à¹ˆà¸™à¸—à¸±à¹‰à¸‡à¸«à¸¡à¸”:** %s", CONFIG.ICONS.TIME, Utils.formatTime(totalTime)),
        string.format("%s **à¹€à¸§à¸Ÿà¸—à¸µà¹ˆà¹„à¸›à¸–à¸¶à¸‡:** %s", CONFIG.ICONS.WAVE, Utils.formatNumber(currentWave)),
        string.format("%s **XP à¸—à¸µà¹ˆà¹„à¸”à¹‰à¸£à¸±à¸š:** %s", CONFIG.ICONS.XP, Utils.formatNumber(result.XP))
    }

    for _, stat in ipairs(result.Description) do
        if stat.N == "Total DMG" then
            table.insert(summaryLines, string.format("%s **à¸„à¸§à¸²à¸¡à¹€à¸ªà¸µà¸¢à¸«à¸²à¸¢à¸—à¸±à¹‰à¸‡à¸«à¸¡à¸”:** %s", CONFIG.ICONS.DAMAGE, Utils.formatNumber(stat.V)))
        elseif stat.N == "Eliminations" then
            table.insert(summaryLines, string.format("%s **à¸¨à¸±à¸•à¸£à¸¹à¸—à¸µà¹ˆà¸à¸³à¸ˆà¸±à¸”:** %s", CONFIG.ICONS.ELIMINATIONS, Utils.formatNumber(stat.V)))
        end
    end

    local characterLines = {}
    local itemLines = {}
    local currencyLines = {}
    local upgradeLines = {}
    local hasCharacterDrop = false

    for _, reward in ipairs(result.Rewards) do
        local rewardName = reward.Name or reward.Type or "à¹„à¸¡à¹ˆà¸—à¸£à¸²à¸šà¸Šà¸·à¹ˆà¸­"
        local currentAmount = Utils.getItemAmount(rewardName)
        local rewardText = string.format("%s **%s** Ã—%s *(à¸£à¸§à¸¡à¹ƒà¸™à¸„à¸¥à¸±à¸‡: %s)*",
            CONFIG.ICONS.REWARDS, rewardName, Utils.formatNumber(reward.Amount), Utils.formatNumber(currentAmount))

        if reward.Type == "Character" then
            hasCharacterDrop = true
            table.insert(characterLines, string.format("%s **ğŸ”¥ à¸”à¸£à¸­à¸›à¸•à¸±à¸§à¸¥à¸°à¸„à¸£à¸ªà¸¸à¸”à¸«à¸²à¸¢à¸²à¸! %s** Ã—%s *(à¸£à¸§à¸¡: %s)*",
                CONFIG.ICONS.CHARACTER, rewardName, Utils.formatNumber(reward.Amount), Utils.formatNumber(currentAmount)))
        elseif reward.Type == "Currency" then
            table.insert(currencyLines, rewardText)
        elseif reward.Type == "Upgrade" then
            table.insert(upgradeLines, string.format("%s **à¸­à¸±à¸›à¹€à¸à¸£à¸”: %s** Ã—%s *(à¸£à¸§à¸¡: %s)*",
                CONFIG.ICONS.UPGRADE, rewardName, Utils.formatNumber(reward.Amount), Utils.formatNumber(currentAmount)))
        else
            table.insert(itemLines, rewardText)
        end
    end

    local gameStatus = isVictory and
        string.format("%s **à¸Šà¸±à¸¢à¸Šà¸™à¸°à¸­à¸±à¸™à¸¢à¸´à¹ˆà¸‡à¹ƒà¸«à¸à¹ˆ!** âœ…", CONFIG.ICONS.VICTORY) or
        string.format("%s **à¸à¹ˆà¸²à¸¢à¹à¸à¹‰à¸­à¸¢à¹ˆà¸²à¸‡à¸™à¹ˆà¸²à¹€à¸ªà¸µà¸¢à¸”à¸²à¸¢** âŒ", CONFIG.ICONS.DEFEAT)

    local embedColor = hasCharacterDrop and CONFIG.COLORS.CHARACTER_DROP or
                      (isVictory and CONFIG.COLORS.VICTORY or CONFIG.COLORS.DEFEAT)

    local embed = {
        title = string.format("ğŸŒŸğŸ”¥ à¸ªà¸£à¸¸à¸›à¸œà¸¥à¸à¸²à¸£à¸•à¹ˆà¸­à¸ªà¸¹à¹‰à¸ªà¸¸à¸”à¸¢à¸´à¹ˆà¸‡à¹ƒà¸«à¸à¹ˆ! â€” %s ğŸ”¥ğŸŒŸ", Players.LocalPlayer.Name),
        description = string.format("**%s**\n*ğŸŒŒ %s â€” %s | à¸œà¸¹à¹‰à¹€à¸¥à¹ˆà¸™ %s à¸„à¸™ | à¹€à¸¥à¹€à¸§à¸¥ %s*",
            gameStatus, info.World.DisplayName, Utils.getDifficultyName(difficulty), Utils.formatNumber(playerCount), Utils.formatNumber(playerLevel)),
        color = embedColor,
        fields = {
            {
                name = string.format("%s ğŸ“Š à¸£à¸²à¸¢à¸¥à¸°à¹€à¸­à¸µà¸¢à¸”à¸à¸²à¸£à¸•à¹ˆà¸­à¸ªà¸¹à¹‰à¸ªà¸¸à¸”à¸¡à¸±à¸™à¸ªà¹Œ", CONFIG.ICONS.SUMMARY),
                value = table.concat(summaryLines, "\n"),
                inline = false
            }
        },
        author = {
            name = "ğŸŒŸ All Star Tower Defense X â€¢ à¸‚à¸±à¸šà¹€à¸„à¸¥à¸·à¹ˆà¸­à¸™à¹‚à¸”à¸¢ Jimi Hub ğŸŒŸ",
            icon_url = "https://media.discordapp.net/attachments/1110521196639944735/1383812269821005915/jimi.png"
        },
        thumbnail = {
            url = "https://tr.rbxcdn.com/180DAY-36ee10a9d4eaa65eedf17feb2b87cc04/256/256/Image/Webp/noFilter"
        },
        footer = {
            text = string.format("ğŸ•’ à¸à¸²à¸£à¸•à¹ˆà¸­à¸ªà¸¹à¹‰à¸ªà¸´à¹‰à¸™à¸ªà¸¸à¸”à¹€à¸¡à¸·à¹ˆà¸­ %s | ASTD X", os.date("%Y-%m-%d %H:%M:%S UTC")),
            icon_url = "https://cdn.discordapp.com/emojis/1234567890123456789.png"
        },
        timestamp = os.date("!%Y-%m-%dT%H:%M:%SZ")
    }

    -- à¹€à¸à¸´à¹ˆà¸¡à¸Ÿà¸´à¸¥à¸”à¹Œà¸ªà¸³à¸«à¸£à¸±à¸šà¸•à¸±à¸§à¸¥à¸°à¸„à¸£à¸—à¸µà¹ˆà¸”à¸£à¸­à¸›
    if #characterLines > 0 then
        table.insert(embed.fields, {
            name = string.format("%s âœ¨ à¸•à¸±à¸§à¸¥à¸°à¸„à¸£à¸ªà¸¸à¸”à¸«à¸²à¸¢à¸²à¸à¸—à¸µà¹ˆà¹„à¸”à¹‰à¸£à¸±à¸š! âœ¨", CONFIG.ICONS.CHARACTER),
            value = table.concat(characterLines, "\n"),
            inline = false
        })
    end

    -- à¹€à¸à¸´à¹ˆà¸¡à¸Ÿà¸´à¸¥à¸”à¹Œà¸ªà¸³à¸«à¸£à¸±à¸šà¸ªà¸à¸¸à¸¥à¹€à¸‡à¸´à¸™
    if #currencyLines > 0 then
        table.insert(embed.fields, {
            name = string.format("%s ğŸ’° à¸ªà¸à¸¸à¸¥à¹€à¸‡à¸´à¸™à¸—à¸µà¹ˆà¹„à¸”à¹‰à¸£à¸±à¸š", CONFIG.ICONS.GEMS),
            value = table.concat(currencyLines, "\n"),
            inline = false
        })
    end

    -- à¹€à¸à¸´à¹ˆà¸¡à¸Ÿà¸´à¸¥à¸”à¹Œà¸ªà¸³à¸«à¸£à¸±à¸šà¸à¸²à¸£à¸­à¸±à¸›à¹€à¸à¸£à¸”
    if #upgradeLines > 0 then
        table.insert(embed.fields, {
            name = string.format("%s âš™ï¸ à¸à¸²à¸£à¸­à¸±à¸›à¹€à¸à¸£à¸”à¸—à¸µà¹ˆà¹„à¸”à¹‰à¸£à¸±à¸š", CONFIG.ICONS.UPGRADE),
            value = table.concat(upgradeLines, "\n"),
            inline = false
        })
    end

    -- à¹€à¸à¸´à¹ˆà¸¡à¸Ÿà¸´à¸¥à¸”à¹Œà¸ªà¸³à¸«à¸£à¸±à¸šà¹„à¸­à¹€à¸—à¸¡à¸—à¸±à¹ˆà¸§à¹„à¸›
    table.insert(embed.fields, {
        name = string.format("%s ğŸ à¸£à¸²à¸‡à¸§à¸±à¸¥à¸­à¸·à¹ˆà¸™à¹† à¸—à¸µà¹ˆà¹„à¸”à¹‰à¸£à¸±à¸š", CONFIG.ICONS.REWARDS),
        value = #itemLines > 0 and table.concat(itemLines, "\n") or "à¹„à¸¡à¹ˆà¸¡à¸µà¸£à¸²à¸‡à¸§à¸±à¸¥à¸­à¸·à¹ˆà¸™",
        inline = false
    })

    return embed
end

function Webhook.send(embed)
    local hasCharacterDrop = #characterLines > 0
    local payload = {
        content = hasCharacterDrop and "ğŸ‰ **ğŸ”¥ à¸”à¸£à¸­à¸›à¸•à¸±à¸§à¸¥à¸°à¸„à¸£à¸ªà¸¸à¸”à¸«à¸²à¸¢à¸²à¸! à¸¡à¸²à¸”à¸¹à¸œà¸¥à¸à¸²à¸£à¸•à¹ˆà¸­à¸ªà¸¹à¹‰à¸ªà¸¸à¸”à¸¢à¸´à¹ˆà¸‡à¹ƒà¸«à¸à¹ˆ! ğŸ”¥** ğŸ‰" or "ğŸŒŸ **à¸œà¸¥à¸à¸²à¸£à¸•à¹ˆà¸­à¸ªà¸¹à¹‰à¸ªà¸¸à¸”à¸¡à¸±à¸™à¸ªà¹Œà¸ˆà¸²à¸ ASTD X!** ğŸŒŸ",
        embeds = { embed },
        attachments = {}
    }

    local success, response = pcall(function()
        local requestFunc = syn and syn.request or request
        return requestFunc({
            Url = _G.WebhookLink,
            Method = "POST",
            Headers = {
                ["Content-Type"] = "application/json"
            },
            Body = HttpService:JSONEncode(payload)
        })
    end)

    if not success then
        warn("à¹„à¸¡à¹ˆà¸ªà¸²à¸¡à¸²à¸£à¸–à¸ªà¹ˆà¸‡ webhook à¹„à¸”à¹‰:", response)
    end
end

-- Main Event Handler
local function handleGameResult(eventData)
    if eventData.Type == "Game" and
       eventData.Mode == "Result" and
       _G.WebhookResultEnd and
       not _G.dbwebhook then

        -- Get Gems data right at result
        local args = {
            {
                Type = "AFK",
                Mode = "Get"
            }
        }
        local GemsData = ReplicatedStorage:WaitForChild("Remotes"):WaitForChild("GetFunction"):InvokeServer(unpack(args))

        _G.dbwebhook = true
        _G.Result = eventData
        _G.GameStatus = eventData.Info.Result.Win and "Victory" or "Defeat"

        local embed = Webhook.createEmbed(eventData, GemsData and GemsData.Cash or 0)
        Webhook.send(embed)

        spawn(function()
            wait(3)
            _G.dbwebhook = nil
        end)
    end
end

-- Connect to game events
ReplicatedStorage.Remotes.UpdateEvent.OnClientEvent:Connect(handleGameResult)

print("ğŸŒŸğŸ”¥ à¸£à¸°à¸šà¸š webhook ASTD X à¸ªà¸¸à¸”à¸­à¸¥à¸±à¸‡à¸à¸²à¸£à¹€à¸£à¸´à¹ˆà¸¡à¸—à¸³à¸‡à¸²à¸™à¸ªà¸³à¹€à¸£à¹‡à¸ˆ! JIMI HUB X CLAUDE AI ğŸ”¥ğŸŒŸ")
